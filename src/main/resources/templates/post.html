<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" href="/common/css/post.css">
</th:block>

<div layout:fragment="content" class="container my-3">

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <a class="btn btn-outline-primary" th:href="@{/posts}">글쓰기</a>
    </div>

    <!-- 검색 필터 -->
    <div class="search">

        <div class="col-3 box">
            <label for="type" class="form-label">모집 구분</label>
            <select class="form-select" aria-label="Default select example" id="type">
                <option value=""></option>
                <option value="스터디">스터디</option>
                <option value="프로젝트">프로젝트</option>
            </select>
        </div>

        <div class="col-3 box">
            <label for="techStack" class="form-label">기술 스택</label>
            <select class="form-select" aria-label="Default select example" id="techStack"
                    multiple="multiple">
                <option value="java">java</option>
                <option value="spring">spring</option>
                <option value="nodeJs">nodeJs</option>
                <option value="vueJs">vueJs</option>
                <option value="react">react</option>
                <option value="Express">Express</option>
                <option value="typeScript">typeScript</option>
                <option value="git">git</option>
                <option value="nextJs">nextJs</option>
            </select>
        </div>

        <div class="col-3 box">
            <label for="position" class="form-label">모집 포지션</label>
            <select class="form-select" aria-label="Default select example" id="position">
                <option value=""></option>
                <option value="백엔드">백엔드</option>
                <option value="프론트엔드">프론트엔드</option>
                <option value="안드로이드">안드로이드</option>
                <option value="IOS">IOS</option>
                <option value="데브옵스">데브옵스</option>
                <option value="디자이너">디자이너</option>
                <option value="기획자">기획자</option>
            </select>
        </div>
    </div>


    <div id="card-container" class="card-container">
        <table class="table">
            <thead class="table-dark">
            <tr class="text-center">
                <th>번호</th>
                <th>모집구분</th>
                <th style="width:30%">제목</th>
                <th>기술스택</th>
                <th>모집포지션</th>
            </tr>
            </thead>
            <tbody class="text-center" id="table_body">
            </tbody>
        </table>

        <div id="pagination" class="pagination justify-content-center">
            <ul class="pagination justify-content-center"></ul>
        </div>
    </div>

    <script layout:fragment="script" type="text/javascript">

        // 페이지 로드 초기화
        $(document).ready(function () {
            $('#techStack').select2();
            let currentPage = 0;
            loadData(currentPage);

            // 이전 페이지 버튼 클릭 시
            $("#prev_button").click(function () {
                if (currentPage > 1) {
                    currentPage--;
                    dataList(currentPage);
                }
            });

            // 다음 페이지 버튼 클릭 시
            $("#next_button").click(function () {
                currentPage++;
                dataList(currentPage);
            });
        });

        // 데이터 요청 및 페이지에 추가
        function loadData(pageNum) {
            console.log("pageNum", pageNum);
            $.ajax({
                url: "api/posts",
                method: "GET",
                data: {page: pageNum},
                contentType: 'application/json',
                success: function (data) {

                    // 데이터 테이블에(화면) 표시
                    dataList(pageNum, data.content, data.totalElements, data.size);

                    // 페이지네이션 컨트롤러 생성, 업데이트
                    pagination(data.totalPages, pageNum);
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        // 테이블 데이터 리스트
        function dataList(pageNum, data, totalElements, size) {
            $('#table_body').empty();
            $.each(data, function (index, item) {
                const rowNumber = totalElements - (pageNum * size) - index;

                const tbody = `
                    <tr class="table_body">
                        <td>${rowNumber}</td>
                        <td>${item.type}</td>
                        <td>${item.title}</td>
                        <td><span>${item.techStack.map(tech => `<span class="circle">${tech}</span>`).join(' ')}</span></td>
                        <td><span>${item.position.map(position => `<span class="circle">${position}</span>`).join(' ')}</span></td>
                    </tr>
                `;
                $('#table_body').append(tbody);
            });

            // 상세페이지 이동
            $('.page_link').click(function () {
                let id = $(this).attr('data-id');
                window.location.href = '/detail/' + id;
            });
        }

        // 페이지네이션
        function pagination(totalPages, pageNum) {
            let currentPage = pageNum;
            let pagination = $('#pagination ul');
            let startPage = Math.max(0, currentPage - 2);
            let endPage = Math.min(totalPages - 1, startPage + 4);
            pagination.empty();

            pagination.append(
                '<li class="page-item ' + (currentPage === 0 ? 'disabled' : '') + '">' +
                '<a class="page-link" onclick="loadData(' + (currentPage - 1) + ')" id="prev_button">이전</a></li>'
            );

            for (let page = startPage; page <= endPage; page++) {
                pagination.append(
                    '<li class="page-item ' + (page === currentPage ? 'active' : '') + '">' +
                    '<a class="page-link" onclick="loadData(' + page + ')">' + (page + 1) + '</a></li>'
                );
            }

            pagination.append(
                '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '">' +
                '<a class="page-link" onclick="loadData(' + (currentPage + 1) + ')" id="next_button">다음</a></li>'
            );
        }
    </script>
</div>
</html>